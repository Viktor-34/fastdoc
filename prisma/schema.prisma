generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Client {
  id            String     @id @default(cuid())
  workspaceId   String
  name          String
  company       String?
  contactPerson String?
  middleName    String?
  position      String?
  email         String
  phone         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  Workspace     Workspace  @relation(fields: [workspaceId], references: [id])
  Proposal      Proposal[]

  @@unique([id, workspaceId])
}

model Events {
  id    String   @id @default(cuid())
  token String
  uid   String
  event String
  ref   String?
  meta  Json?
  ts    DateTime @default(now())

  @@index([token])
  @@index([uid])
}

model PriceItem {
  id        String   @id @default(cuid())
  productId String
  label     String
  qty       Int      @default(1)
  unitPrice Decimal  @db.Decimal(12, 2)
  discount  Decimal? @db.Decimal(5, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Product   Product  @relation(fields: [productId], references: [id])
}

model Product {
  id          String      @id @default(cuid())
  workspaceId String
  name        String
  sku         String?     @unique
  description String?
  currency    String      @default("RUB")
  basePrice   Decimal     @db.Decimal(12, 2)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  PriceItem   PriceItem[]
  Workspace   Workspace   @relation(fields: [workspaceId], references: [id])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ShareLink {
  id           String    @id @default(cuid())
  proposalId   String?
  token        String    @unique
  expiresAt    DateTime?
  allowPdf     Boolean   @default(true)
  utmSource    String?
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  Proposal     Proposal? @relation(fields: [proposalId], references: [id], onDelete: Cascade)
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  workspaceId   String?
  role          Role       @default(EDITOR)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  Workspace     Workspace? @relation(fields: [workspaceId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Workspace {
  id        String     @id @default(cuid())
  name      String
  createdAt DateTime   @default(now())

  // Визуал компании
  logoUrl      String?
  signatureUrl String?
  stampUrl     String?

  // Реквизиты (РФ специфика)
  companyName   String?
  inn           String?
  ogrn          String?
  legalAddress  String?
  bankName      String?
  bik           String?
  accountNumber String?

  // Настройки НДС
  vatDefault Boolean @default(true)
  vatRate    Int     @default(20)

  Client            Client[]
  Product           Product[]
  User              User[]
  Proposal          Proposal[]
  ProposalTemplate  ProposalTemplate[]
}

model Proposal {
  id             String    @id @default(cuid())
  workspaceId    String
  clientId       String?

  // Основная информация
  title          String
  recipientName  String?

  // Контекст и решение
  problemDesc    String?   @db.Text
  solutionDesc   String?   @db.Text
  additionalDesc String?   @db.Text

  // Товары/услуги (JSON массив ProposalItem[])
  items          Json
  currency       String    @default("RUB")
  pricingMode    String    @default("single")
  productVariants Json?
  activeVariantId String?
  productsView   Json?

  // Условия
  deadline       String?
  paymentTerms   String?
  paymentCustom  String?
  validUntil     DateTime?

  // НДС
  includeVat     Boolean   @default(true)
  vatRate        Int       @default(20)

  // Галерея (JSON массив URL строк)
  galleryImages  Json?

  // Преимущества (JSON массив карточек с иконкой, заголовком и описанием)
  advantages     Json?
  advantagesColumns Int @default(3)

  // Настройки видимости разделов (JSON массив названий секций)
  visibleSections Json?

  // CTA (призыв к действию)
  ctaText        String?
  ctaPhone       String?
  ctaEmail       String?

  // Дополнительно
  notes          String?   @db.Text

  // Метаданные
  version        Int       @default(1)
  status         String    @default("draft")
  createdBy      String
  updatedBy      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Связи
  Workspace      Workspace         @relation(fields: [workspaceId], references: [id])
  Client         Client?           @relation(fields: [clientId], references: [id])
  Versions       ProposalVersion[]
  ShareLinks     ShareLink[]

  @@index([workspaceId])
  @@index([workspaceId, updatedAt(sort: Desc)])
  @@index([clientId])
  @@index([status])
}

model ProposalVersion {
  id         String   @id @default(cuid())
  proposalId String
  version    Int
  snapshot   Json
  createdAt  DateTime @default(now())

  Proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, version])
}

model ProposalTemplate {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  description String?
  category    String?

  // Preset values (JSON содержит Partial<Proposal>)
  defaults    Json

  // Настройки отображения (JSON массив названий секций)
  sections    Json

  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  Workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}
