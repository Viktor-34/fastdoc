{"version":3,"sources":["turbopack:///[project]/app/p/[token]/PublicPreviewClient.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useState } from 'react';\n\ninterface PublicPreviewClientProps {\n  token: string;\n  proposalHtml: string;\n}\n\nexport default function PublicPreviewClient({ token, proposalHtml }: PublicPreviewClientProps) {\n  const [iframeHeight, setIframeHeight] = useState('100vh');\n\n  useEffect(() => {\n    const handleMessage = (event: MessageEvent) => {\n      if (event.data?.type !== 'resize') {\n        return;\n      }\n\n      const rawHeight = event.data.height;\n      if (typeof rawHeight !== 'number' || !Number.isFinite(rawHeight)) {\n        return;\n      }\n\n      const nextHeight = Math.max(320, Math.round(rawHeight + 40));\n      setIframeHeight(`${nextHeight}px`);\n    };\n\n    window.addEventListener('message', handleMessage);\n    return () => {\n      window.removeEventListener('message', handleMessage);\n    };\n  }, []);\n\n  useEffect(() => {\n    const uidKey = 'uid';\n    let uid = localStorage.getItem(uidKey);\n    if (!uid) {\n      uid = Math.random().toString(36).slice(2);\n      localStorage.setItem(uidKey, uid);\n    }\n\n    const ping = (event: string, meta: Record<string, unknown> = {}) => {\n      fetch('/api/track', {\n        method: 'POST',\n        headers: { 'content-type': 'application/json' },\n        body: JSON.stringify({ token, event, uid, meta, ref: document.referrer }),\n      }).catch(() => {\n        // Best-effort analytics, do not block UI.\n      });\n    };\n\n    ping('opened');\n\n    let intervalId: number | null = null;\n    const start = () => {\n      if (intervalId !== null) {\n        return;\n      }\n      intervalId = window.setInterval(() => ping('time', { seconds: 15 }), 15000);\n    };\n\n    const stop = () => {\n      if (intervalId === null) {\n        return;\n      }\n      window.clearInterval(intervalId);\n      intervalId = null;\n    };\n\n    const onVisibilityChange = () => {\n      if (document.visibilityState === 'visible') {\n        start();\n      } else {\n        stop();\n      }\n    };\n\n    document.addEventListener('visibilitychange', onVisibilityChange);\n    if (document.visibilityState === 'visible') {\n      start();\n    }\n\n    return () => {\n      stop();\n      document.removeEventListener('visibilitychange', onVisibilityChange);\n    };\n  }, [token]);\n\n  const handleDownload = () => {\n    const uid = localStorage.getItem('uid');\n    fetch('/api/track', {\n      method: 'POST',\n      headers: { 'content-type': 'application/json' },\n      body: JSON.stringify({ token, event: 'download', uid: uid || undefined, ref: document.referrer }),\n    }).catch(() => {\n      // Best-effort analytics, do not block UI.\n    });\n\n    window.open(`/p/${token}/pdf`, '_blank', 'noopener,noreferrer');\n  };\n\n  return (\n    <div className=\"public-preview\">\n      <div\n        style={{\n          width: 'min(900px, 100%)',\n          margin: '0 auto',\n          background: '#ffffff',\n          borderRadius: '20px',\n          boxShadow: '0 24px 48px -32px rgba(15,23,42,0.25)',\n          overflow: 'hidden',\n        }}\n      >\n        <iframe\n          srcDoc={proposalHtml}\n          style={{\n            width: '100%',\n            height: iframeHeight,\n            border: 'none',\n            display: 'block',\n          }}\n          title=\"Коммерческое предложение\"\n        />\n      </div>\n\n      <div style={{ textAlign: 'center', margin: '32px 0' }}>\n        <button type=\"button\" id=\"downloadPdf\" className=\"download-button\" onClick={handleDownload}>\n          Скачать PDF\n        </button>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"+EAEA,EAAA,EAAA,CAAA,CAAA,OAOe,SAAS,EAAoB,OAAE,CAAK,cAAE,CAAY,CAA4B,EAC3F,GAAM,CAAC,EAAc,EAAgB,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,eAEjD,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACR,IAAM,EAAgB,AAAC,IACrB,GAAI,EAAM,IAAI,EAAE,OAAS,SACvB,CADiC,MAInC,IAAM,EAAY,EAAM,IAAI,CAAC,MAAM,CACnC,GAAI,AAAqB,iBAAd,GAA0B,CAAC,OAAO,QAAQ,CAAC,GACpD,OAGF,EAJkE,EAI5D,EAAa,KAAK,GAAG,CAAC,IAAK,KAAK,KAAK,CAAC,EAAY,KACxD,EAAgB,CAAA,EAAG,EAAW,EAAE,CAAC,CACnC,EAGA,OADA,OAAO,gBAAgB,CAAC,UAAW,GAC5B,KACL,OAAO,mBAAmB,CAAC,UAAW,EACxC,CACF,EAAG,EAAE,EAEL,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KAER,IAAI,EAAM,aAAa,OAAO,CAAC,OAC1B,IACH,CADQ,CACF,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,KAAK,CAAC,GACvC,aAAa,OAAO,CAAC,AAJR,MAIgB,IAG/B,IAAM,EAAO,CAAC,EAAe,EAAgC,CAAC,CAAC,IAC7D,MAAM,aAAc,CAClB,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,OAAE,QAAO,MAAO,OAAK,EAAM,IAAK,SAAS,QAAQ,AAAC,EACzE,GAAG,KAAK,CAAC,KAET,EACF,EAEA,EAAK,UAEL,IAAI,EAA4B,KAC1B,EAAQ,KACO,MAAM,CAArB,IAGJ,EAAa,OAAO,WAAW,CAAC,IAAM,EAAK,OAAQ,CAAE,QAAS,EAAG,GAAI,KAAA,CACvE,EAEM,EAAO,KACQ,MAAM,CAArB,IAGJ,OAAO,aAAa,CAAC,GACrB,EAAa,KACf,EAEM,EAAqB,KACQ,WAAW,CAAxC,SAAS,eAAe,CAC1B,IAEA,GAEJ,EAOA,OALA,SAAS,gBAAgB,CAAC,mBAAoB,GACb,WAAW,CAAxC,SAAS,eAAe,EAC1B,IAGK,KACL,IACA,SAAS,mBAAmB,CAAC,mBAAoB,EACnD,CACF,EAAG,CAAC,EAAM,EAgBR,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,2BACb,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CACC,MAAO,CACL,MAAO,mBACP,OAAQ,SACR,WAAY,UACZ,aAAc,OACd,UAAW,wCACX,SAAU,QACZ,WAEA,CAAA,EAAA,EAAA,GAAA,EAAC,SAAA,CACC,OAAQ,EACR,MAAO,CACL,MAAO,OACP,OAAQ,EACR,OAAQ,OACR,QAAS,OACX,EACA,MAAM,+BAIV,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,MAAO,CAAE,UAAW,SAAU,OAAQ,QAAS,WAClD,CAAA,EAAA,EAAA,GAAA,EAAC,SAAA,CAAO,KAAK,SAAS,GAAG,cAAc,UAAU,kBAAkB,QAtClD,CAsC2D,IApChF,MAAM,aAAc,CAClB,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,OAAE,EAAO,MAAO,WAAY,IAAK,AAJ5C,aAAa,OAAO,CAAC,aAI8B,EAAW,IAAK,SAAS,QAAQ,AAAC,EACjG,GAAG,KAAK,CAAC,KAET,GAEA,OAAO,IAAI,CAAC,CAAC,GAAG,EAAE,EAAM,IAAI,CAAC,CAAE,SAAU,sBAC3C,WA2BkG,oBAMpG"}